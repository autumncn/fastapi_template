{% extends "shared/base.html" %}

{% block link %}
{% endblock %}

{% block title %}
    <title>{{ _('title_stable_diffusion') }} - {{ _('title_tasks') }}</title>
{% endblock %}

{% block main %}
<header class="page-header page-header-compact page-header-light border-bottom bg-white mb-4">
    <div class="container-fluid px-4">
        <div class="page-header-content">
            <div class="row align-items-center justify-content-between pt-3">
                <div class="col-auto mb-3">
                    <h1 class="page-header-title">
                        <div class="page-header-icon"><i data-feather="cloud"></i></div>
                        {{ _('title_stable_diffusion') }} - {{ _('title_tasks') }}
                    </h1>
                </div>
                <div class="col-12 col-xl-auto mb-3">
                    <a class="btn btn-sm btn-light text-primary" href="javascript:history.back();">
                        <i class="me-1" data-feather="arrow-left"></i>
                        {{ _('back') }}
                    </a>
                </div>
            </div>
        </div>
    </div>
</header>
<!-- Main page content-->
<div class="container-fluid px-4">
    <div class="card mb-4">
        <div class="card-header"></div>
        <div class="card-body">
            <table id="datatablesSimple" class="table table-hover table-borderless align-middle datatable-table">
                <thead>
                        <tr>
                            <th>{{ _('uid') }}</th>
                            <th>{{ _('status') }}</th>
                            <th>{{ _('progress') }}</th>
                            <th>{{ _('action') }}</th>
                        </tr>
                </thead>
                <tbody>
                        {% for task in task_list %}
                        <tr>
                            <td>{{ task.uid }}</td>
                            <td><div id="status_{{ loop.index }}">{% if task.status==-2 %}{{ _('unknown') }}{% elif task.status==-1 %}{{ _('failed') }}{% elif task.status==0 %}{{ _('not_ready') }}{% elif task.status==1 %}{{ _('pending') }}{% elif task.status==2 %}{{ _('started') }}{% elif task.status==3 %}{{ _('completed') }}{% else %}{{ _('unknown') }}{% endif %}</div></td>
                            <td>
                                <div id="{{ task.uid }}">
                                        <div class="progress" id="progress_bg_{{ loop.index }}" role="progressbar" aria-label="Example with label" aria-valuenow="
                                                {% if task.status<=1 %}0
                                                {% elif task.status==3 %}100
                                                {% else %}100
                                                {% endif %}100
                                                " aria-valuemin="0" aria-valuemax="100">
                                              <div id="progress_bar_{{ loop.index }}" class="progress-bar overflow-visible text-dark" style="width:
                                                {% if task.status<=1 %}0%
                                                {% elif task.status==3 %}100%
                                                {% else %}100%
                                                {% endif %}">
                                                {% if task.status<=1 %}0%
                                                {% elif task.status==3 %}100%
                                                {% else %}100%
                                                {% endif %}
                                              </div>
                                        </div>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                        data-bs-target="#modal"
                                        onclick="show_image('{{ task.uid }}', 0)">{{ _('original') }}
                                </button>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                        data-bs-target="#modal"
                                        {% if task.status==3 %}
                                        {% else %}disabled
                                        {% endif %}
                                        onclick="show_image('{{ task.uid }}', 1)">{{ _('generated') }}
                                </button>
                                <form action="/stables/task/{{ task.uid }}/delete" method="POST" style="display: inline-block;">
                                    <input type="submit" class="btn btn-danger btn-sm" value="{{ _('delete') }}">
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function checkStatus() {
    const task_list = document.getElementById('datatablesSimple');
    const listItems = task_list.getElementsByTagName('tr');

    for (let i = 1; i < listItems.length; i++) {
        var task_id = listItems[i].getElementsByTagName('td')[0].innerHTML;
<!--        var task_status = listItems[i].getElementsByTagName('td')[1].innerHTML;-->
        var task_status = document.getElementById('status_'+i).innerHTML;
        var new_id  = document.getElementById('progress_bg_'+i);

        console.log(task_id, task_status);
        if (task_status == '{{ _('started') }}') {
            var worki_id = i-1;
            console.log("需要执行 --> ",worki_id, task_id);
            updateProgress(worki_id, task_id);
        }
    }
}

window.onload = checkStatus;

function updateProgress(index_id, task_uid) {
    new_index_id = index_id + 1;
    console.log("执行 --> ",index_id);
    $.getJSON("/stables/progress_by_task?task_uid="+task_uid, function(data) {
        var progress_percentage = data.data.percent.toFixed(0);
        console.log(progress_percentage);
        var progress_bg_div = document.getElementById("progress_bg_"+new_index_id);
        var progress_bar_div = document.getElementById("progress_bar_"+new_index_id);
        var status_div = document.getElementById("status_"+new_index_id);

        progress_bg_div.setAttribute("aria-valuenow", progress_percentage);
        progress_bar_div.style.width = progress_percentage + "%";
        progress_bar_div.innerHTML = progress_percentage + "%";
      if ( 0< progress_percentage && progress_percentage < 100) {
          setTimeout(function() {
              console.log('Pause for 2 seconds');
            }, 2000);
            updateProgress(index_id, task_uid);
        }else {
            progress_bg_div.setAttribute("aria-valuenow", 100);
            progress_bar_div.style.width = 100 + "%";
            progress_bar_div.innerHTML = 100 + "%";
            status_div.innerHTML = "{{ _('completed') }}";
<!--            setTimeout(location.reload(), 1000);-->
        }
    });
}

function show_image(uid, type) {
    console.log(uid);
    params = {
        'uid': uid
    };
    $.getJSON("/stables/get_image_by_task?" + $.param(params), function(data) {
        var image_prompt = data.data.prompt;
        var image_seed = data.data.seed;
        var image_type = data.data.type;
        var image_step = data.data.step;
        var image_cfg = data.data.cfg;
        var image_controlnet_mode = data.data.controlnet_mode;
        var image_uri = data.data.uri;
        var image_content = data.data.content;
        var image_content_new = data.data.content_new;

        var settings = "{{ _('prompt') }}: " + image_prompt + "\n{{ _('performance') }}: " + image_step + '\n{{ _('ai_level') }}: ' + image_cfg + '\n{{ _('controlnet_mode') }}: ' + image_controlnet_mode;

        var modal = document.getElementById('modal');
        var modal_dialog = document.getElementById('modal_dialog');
        modal_dialog.classList.add('modal-lg');

        var titleElement = document.getElementById('modal_title');
        var descriptionElement = document.getElementById('modal_body');
        var modal_body_html = document.getElementById("modal_insert").innerHTML;

        var base64String = 'data:image/png;base64,' + image_content // 替换为实际的 base64 字符串
        var img = new Image();
        img.src = base64String;

        img.onload = function() {
          // 获取图片的自然高度和自然宽度
          var naturalHeight = img.naturalHeight;
          var naturalWidth = img.naturalWidth;
<!--          modal.style.width = naturalWidth + 900 + 'px';-->

        };
        show_content = image_content
        descriptionElement.textContent = image_prompt;
        if (type == 1) {
            show_content = image_content_new
            descriptionElement.textContent = settings;
            descriptionElement.style.whiteSpace= "break-spaces";
        }
        // 填充数据
        titleElement.textContent = image_uri;
        image_html = "<img style='padding:10px;  width:-webkit-fill-available;'  src='data:image/png;base64," + show_content + "'>";
        document.getElementById("modal_insert").innerHTML = image_html;
    });
}
</script>
{% endblock %}

